<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tips for making your package work with AD · ChainRules</title><meta name="title" content="Tips for making your package work with AD · ChainRules"/><meta property="og:title" content="Tips for making your package work with AD · ChainRules"/><meta property="twitter:title" content="Tips for making your package work with AD · ChainRules"/><meta name="description" content="Documentation for ChainRules."/><meta property="og:description" content="Documentation for ChainRules."/><meta property="twitter:description" content="Documentation for ChainRules."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../index.html"><img src="../assets/logo.svg" alt="ChainRules logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../index.html">ChainRules</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../index.html">Introduction</a></li><li><span class="tocitem">How to use ChainRules as a rule author</span><ul><li><a class="tocitem" href="intro.html">Introduction</a></li><li><a class="tocitem" href="example.html">Pedagogical example</a></li><li><a class="tocitem" href="tangents.html">Tangent types</a></li><li><a class="tocitem" href="which_functions_need_rules.html">Which functions need rules?</a></li><li><a class="tocitem" href="rule_definition_tools.html">Rule definition tools</a></li><li><a class="tocitem" href="writing_good_rules.html">Writing good rules</a></li><li><a class="tocitem" href="testing.html">Testing your rules</a></li><li><input class="collapse-toggle" id="menuitem-2-8" type="checkbox"/><label class="tocitem" for="menuitem-2-8"><span class="docs-label">Superpowers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="superpowers/projectto.html"><code>ProjectTo</code></a></li><li><a class="tocitem" href="superpowers/opt_out.html"><code>@opt_out</code></a></li><li><a class="tocitem" href="superpowers/ruleconfig.html"><code>RuleConfig</code></a></li><li><a class="tocitem" href="superpowers/gradient_accumulation.html">Gradient accumulation</a></li><li><a class="tocitem" href="superpowers/mutation_support.html">Mutation Support (experimental)</a></li></ul></li><li><a class="tocitem" href="converting_zygoterules.html">Converting ZygoteRules.@adjoint to rrules</a></li><li class="is-active"><a class="tocitem" href="tips_for_packages.html">Tips for making your package work with AD</a><ul class="internal"><li><a class="tocitem" href="#Ignoring-gradients-for-certain-expressions"><span>Ignoring gradients for certain expressions</span></a></li></ul></li><li><a class="tocitem" href="debug_mode.html">Debug mode</a></li></ul></li><li><span class="tocitem">How to support ChainRules rules as an AD package author</span><ul><li><a class="tocitem" href="../ad_author/use_in_ad_system.html">Usage in AD</a></li><li><a class="tocitem" href="../ad_author/call_back_into_ad.html">Support calling back into ADs</a></li><li><a class="tocitem" href="../ad_author/opt_out.html">Support opting out of rules</a></li></ul></li><li><span class="tocitem">The maths</span><ul><li><a class="tocitem" href="../maths/propagators.html">The propagators: pushforward and pullback</a></li><li><a class="tocitem" href="../maths/nondiff_points.html">Non-differentiable Points</a></li><li><a class="tocitem" href="../maths/complex.html">Complex numbers</a></li><li><a class="tocitem" href="../maths/arrays.html">Deriving array rules</a></li></ul></li><li><span class="tocitem">Design</span><ul><li><a class="tocitem" href="../design/changing_the_primal.html">Changing the Primal</a></li><li><a class="tocitem" href="../design/many_tangents.html">Many Tangent Types</a></li></ul></li><li><a class="tocitem" href="../videos.html">Videos</a></li><li><a class="tocitem" href="../FAQ.html">FAQ</a></li><li><a class="tocitem" href="../api.html">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How to use ChainRules as a rule author</a></li><li class="is-active"><a href="tips_for_packages.html">Tips for making your package work with AD</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="tips_for_packages.html">Tips for making your package work with AD</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaDiff/ChainRulesCore.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaDiff/ChainRulesCore.jl/blob/main/docs/src/rule_author/tips_for_packages.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Tips-for-making-your-package-work-with-AD"><a class="docs-heading-anchor" href="#Tips-for-making-your-package-work-with-AD">Tips for making your package work with AD</a><a id="Tips-for-making-your-package-work-with-AD-1"></a><a class="docs-heading-anchor-permalink" href="#Tips-for-making-your-package-work-with-AD" title="Permalink"></a></h1><h2 id="Ignoring-gradients-for-certain-expressions"><a class="docs-heading-anchor" href="#Ignoring-gradients-for-certain-expressions">Ignoring gradients for certain expressions</a><a id="Ignoring-gradients-for-certain-expressions-1"></a><a class="docs-heading-anchor-permalink" href="#Ignoring-gradients-for-certain-expressions" title="Permalink"></a></h2><p>There exists code that is not meant to be differentiated through, for example logging. In some cases, AD systems might work perfectly well with that code, but in others they might not. A convenience function <code>ignore_derivatives</code> is provided to get around this issue. It captures the functionality of both <code>Zygote.ignore</code> and <code>Zygote.dropgrad</code>.</p><p>For example, Zygote does not support mutation, so it will break if you try to store intermediate values as in the following example:</p><pre><code class="language-julia hljs">somes = []
things = []

function loss(x, y)
    some = f(x, y)
    thing = g(x)
    
    # log
    push!(somes, some)
    push!(things, thing)

    return some + thing
end</code></pre><p>It is possible to get around this by using the <code>ignore_derivatives</code> function</p><pre><code class="language-julia hljs">ignore_derivatives() do
    push!(somes, some)
    push!(things, thing)
end</code></pre><p>or using a macro for one-liners</p><pre><code class="language-julia hljs">@ignore_derivatives push!(things, thing)</code></pre><p>It is also possible to use this on individual objects, e.g.</p><pre><code class="language-julia hljs">ignore_derivatives(a) + b</code></pre><p>will ignore the gradients for <code>a</code> only.</p><p>Passing in instances of functors (callable structs), <code>ignore_derivatives(functor)</code>, will make them behave like normal structs, i.e. propagate without being called and dropping their gradients. If you want to call a functor in the primal computation, wrap it in a closure: <code>ignore_derivatives(() -&gt; functor())</code></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="converting_zygoterules.html">« Converting ZygoteRules.@adjoint to rrules</a><a class="docs-footer-nextpage" href="debug_mode.html">Debug mode »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Monday 16 June 2025 07:25">Monday 16 June 2025</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>

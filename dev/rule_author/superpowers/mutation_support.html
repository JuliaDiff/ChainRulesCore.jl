<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Mutation Support (experimental) · ChainRules</title><meta name="title" content="Mutation Support (experimental) · ChainRules"/><meta property="og:title" content="Mutation Support (experimental) · ChainRules"/><meta property="twitter:title" content="Mutation Support (experimental) · ChainRules"/><meta name="description" content="Documentation for ChainRules."/><meta property="og:description" content="Documentation for ChainRules."/><meta property="twitter:description" content="Documentation for ChainRules."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../index.html"><img src="../../assets/logo.svg" alt="ChainRules logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../index.html">ChainRules</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../index.html">Introduction</a></li><li><span class="tocitem">How to use ChainRules as a rule author</span><ul><li><a class="tocitem" href="../intro.html">Introduction</a></li><li><a class="tocitem" href="../example.html">Pedagogical example</a></li><li><a class="tocitem" href="../tangents.html">Tangent types</a></li><li><a class="tocitem" href="../which_functions_need_rules.html">Which functions need rules?</a></li><li><a class="tocitem" href="../rule_definition_tools.html">Rule definition tools</a></li><li><a class="tocitem" href="../writing_good_rules.html">Writing good rules</a></li><li><a class="tocitem" href="../testing.html">Testing your rules</a></li><li><input class="collapse-toggle" id="menuitem-2-8" type="checkbox" checked/><label class="tocitem" for="menuitem-2-8"><span class="docs-label">Superpowers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="projectto.html"><code>ProjectTo</code></a></li><li><a class="tocitem" href="opt_out.html"><code>@opt_out</code></a></li><li><a class="tocitem" href="ruleconfig.html"><code>RuleConfig</code></a></li><li><a class="tocitem" href="gradient_accumulation.html">Gradient accumulation</a></li><li class="is-active"><a class="tocitem" href="mutation_support.html">Mutation Support (experimental)</a><ul class="internal"><li><a class="tocitem" href="#MutableTangent"><span><code>MutableTangent</code></span></a></li><li><a class="tocitem" href="#zero_tangent"><span><code>zero_tangent</code></span></a></li><li><a class="tocitem" href="#Writing-a-frule-for-a-mutating-function"><span>Writing a frule for a mutating function</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../converting_zygoterules.html">Converting ZygoteRules.@adjoint to rrules</a></li><li><a class="tocitem" href="../tips_for_packages.html">Tips for making your package work with AD</a></li><li><a class="tocitem" href="../debug_mode.html">Debug mode</a></li></ul></li><li><span class="tocitem">How to support ChainRules rules as an AD package author</span><ul><li><a class="tocitem" href="../../ad_author/use_in_ad_system.html">Usage in AD</a></li><li><a class="tocitem" href="../../ad_author/call_back_into_ad.html">Support calling back into ADs</a></li><li><a class="tocitem" href="../../ad_author/opt_out.html">Support opting out of rules</a></li></ul></li><li><span class="tocitem">The maths</span><ul><li><a class="tocitem" href="../../maths/propagators.html">The propagators: pushforward and pullback</a></li><li><a class="tocitem" href="../../maths/nondiff_points.html">Non-differentiable Points</a></li><li><a class="tocitem" href="../../maths/complex.html">Complex numbers</a></li><li><a class="tocitem" href="../../maths/arrays.html">Deriving array rules</a></li></ul></li><li><span class="tocitem">Design</span><ul><li><a class="tocitem" href="../../design/changing_the_primal.html">Changing the Primal</a></li><li><a class="tocitem" href="../../design/many_tangents.html">Many Tangent Types</a></li></ul></li><li><a class="tocitem" href="../../videos.html">Videos</a></li><li><a class="tocitem" href="../../FAQ.html">FAQ</a></li><li><a class="tocitem" href="../../api.html">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How to use ChainRules as a rule author</a></li><li><a class="is-disabled">Superpowers</a></li><li class="is-active"><a href="mutation_support.html">Mutation Support (experimental)</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="mutation_support.html">Mutation Support (experimental)</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaDiff/ChainRulesCore.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaDiff/ChainRulesCore.jl/blob/main/docs/src/rule_author/superpowers/mutation_support.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Mutation-Support"><a class="docs-heading-anchor" href="#Mutation-Support">Mutation Support</a><a id="Mutation-Support-1"></a><a class="docs-heading-anchor-permalink" href="#Mutation-Support" title="Permalink"></a></h1><p>ChainRulesCore.jl offers experimental support for mutation, targeting use in forward mode AD. (Mutation support in reverse mode AD is more complicated and will likely require more changes to the interface)</p><div class="admonition is-warning"><header class="admonition-header">Experimental</header><div class="admonition-body"><p>This page documents an experimental feature. Expect breaking changes in minor versions while this remains. It is not suitable for general use unless you are prepared to modify how you are using it each minor release. It is thus suggested that if you are using it to use <em>tilde</em> bounds on supported minor versions.</p></div></div><h2 id="MutableTangent"><a class="docs-heading-anchor" href="#MutableTangent"><code>MutableTangent</code></a><a id="MutableTangent-1"></a><a class="docs-heading-anchor-permalink" href="#MutableTangent" title="Permalink"></a></h2><p>The <a href="../../api.html#ChainRulesCore.MutableTangent"><code>MutableTangent</code></a> type is designed to be a partner to the <a href="../../api.html#ChainRulesCore.Tangent"><code>Tangent</code></a> type, with specific support for being mutated in place. It is required to be a structural tangent, having one tangent for each field of the primal object.</p><p>Technically, not all <code>mutable struct</code>s need to use <code>MutableTangent</code> to represent their tangents. Just like not all <code>struct</code>s need to use <code>Tangent</code>s. Common examples away from this are natural tangent types like for arrays. However, if one is setting up to use a custom tangent type for this it is sufficiently off the beaten path that we can not provide much guidance.</p><h2 id="zero_tangent"><a class="docs-heading-anchor" href="#zero_tangent"><code>zero_tangent</code></a><a id="zero_tangent-1"></a><a class="docs-heading-anchor-permalink" href="#zero_tangent" title="Permalink"></a></h2><p>The <a href="../../api.html#ChainRulesCore.zero_tangent"><code>zero_tangent</code></a> function functions to give you a zero (i.e. additive identity) for any primal value. The <a href="../../api.html#ChainRulesCore.ZeroTangent"><code>ZeroTangent</code></a> type also does this. The difference is that <a href="../../api.html#ChainRulesCore.zero_tangent"><code>zero_tangent</code></a> is in general full structural tangent mirroring the structure of the primal. To be technical the promise of <a href="../../api.html#ChainRulesCore.zero_tangent"><code>zero_tangent</code></a> is that it will be a value that supports mutation. However, in practice<sup class="footnote-reference"><a id="citeref-1" href="#footnote-1">[1]</a></sup> this is achieved through in a structural tangent For mutation support this is important, since it means that there is mutable memory available in the tangent to be mutated when the primal changes. To support this you thus need to make sure your zeros are created in various places with <a href="../../api.html#ChainRulesCore.zero_tangent"><code>zero_tangent</code></a> rather than []<code>ZeroTangent</code>](@ref).</p><p>It is also useful for reasons of type stability, since it forces a consistent type (generally a structural tangent) for any given primal type. For this reason AD system implementors might chose to use this to create the tangent for all literal values they encounter, mutable or not, and to process the output of <code>frule</code>s to convert <a href="../../api.html#ChainRulesCore.ZeroTangent"><code>ZeroTangent</code></a> into corresponding <a href="../../api.html#ChainRulesCore.zero_tangent"><code>zero_tangent</code></a>s.</p><h2 id="Writing-a-frule-for-a-mutating-function"><a class="docs-heading-anchor" href="#Writing-a-frule-for-a-mutating-function">Writing a frule for a mutating function</a><a id="Writing-a-frule-for-a-mutating-function-1"></a><a class="docs-heading-anchor-permalink" href="#Writing-a-frule-for-a-mutating-function" title="Permalink"></a></h2><p>It is relatively straight forward to write a frule for a mutating function. There are a few key points to follow:</p><ul><li>There must be a mutable tangent input for every mutated primal input</li><li>When the primal value is changed, the corresponding change must be made to its tangent partner</li><li>When a value is returned, return its partnered tangent.</li><li>If (and only if) primal values alias, then their tangents must also alias.</li></ul><h3 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h3><p>For example, consider the primal function with:</p><ol><li>takes two <code>Ref</code>s</li><li>doubles the first one in place</li><li>overwrites the second one&#39;s value with the literal 5.0</li><li>returns the first one</li></ol><pre><code class="language-julia hljs">function foo!(a::Base.RefValue, b::Base.RefValue)
    a[] *= 2
    b[] = 5.0
    return a
end</code></pre><p>The frule for this would be:</p><pre><code class="language-julia hljs">function ChainRulesCore.frule((_, ȧ, ḃ), ::typeof(foo!), a::Base.RefValue, b::Base.RefValue)
    @assert ȧ isa MutableTangent{typeof(a)}
    @assert ḃ isa MutableTangent{typeof(b)}

    a[] *= 2
    ȧ.x *= 2  # `.x` is the field that lives behind RefValues

    b[] = 5.0
    ḃ.x = zero_tangent(5.0)  # or since we know that the zero for a Float64 is zero could write `ḃ.x = 0.0`

    return a, ȧ
end</code></pre><p>Then assuming the AD system does its part to makes sure you are indeed given mutable values to mutate (i.e. those <code>@assert</code>ions are true) then all is well and this rule will make mutation correct.</p><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-1"><a class="tag is-link" href="#citeref-1">1</a>Further, it is hard to achieve this promise of allowing mutation to be supported without returning a structural tangent. Except in the special case of where the struct is not mutable and has no nested fields that are mutable.</li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="gradient_accumulation.html">« Gradient accumulation</a><a class="docs-footer-nextpage" href="../converting_zygoterules.html">Converting ZygoteRules.@adjoint to rrules »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Thursday 8 February 2024 11:14">Thursday 8 February 2024</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>

<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>RuleConfig · ChainRules</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../index.html"><img src="../../assets/logo.svg" alt="ChainRules logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../index.html">ChainRules</a></span></div><form class="docs-search" action="../../search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../index.html">Introduction</a></li><li><span class="tocitem">How to use ChainRules as a rule author</span><ul><li><a class="tocitem" href="../intro.html">Introduction</a></li><li><a class="tocitem" href="../example.html">Pedagogical example</a></li><li><a class="tocitem" href="../tangents.html">Tangent types</a></li><li><a class="tocitem" href="../which_functions_need_rules.html">Which functions need rules?</a></li><li><a class="tocitem" href="../rule_definition_tools.html">Rule definition tools</a></li><li><a class="tocitem" href="../writing_good_rules.html">Writing good rules</a></li><li><a class="tocitem" href="../testing.html">Testing your rules</a></li><li><input class="collapse-toggle" id="menuitem-2-8" type="checkbox" checked/><label class="tocitem" for="menuitem-2-8"><span class="docs-label">Superpowers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="projectto.html"><code>ProjectTo</code></a></li><li><a class="tocitem" href="opt_out.html"><code>@opt_out</code></a></li><li class="is-active"><a class="tocitem" href="ruleconfig.html"><code>RuleConfig</code></a><ul class="internal"><li><a class="tocitem" href="#Writing-rules-that-call-back-into-AD"><span>Writing rules that call back into AD</span></a></li><li><a class="tocitem" href="#Writing-rules-that-depend-on-other-special-requirements-of-the-AD."><span>Writing rules that depend on other special requirements of the AD.</span></a></li><li><a class="tocitem" href="#Writing-rules-that-are-only-for-your-own-AD"><span>Writing rules that are only for your own AD</span></a></li></ul></li><li><a class="tocitem" href="gradient_accumulation.html">Gradient accumulation</a></li></ul></li><li><a class="tocitem" href="../converting_zygoterules.html">Converting ZygoteRules.@adjoint to rrules</a></li><li><a class="tocitem" href="../tips_for_packages.html">Tips for making your package work with AD</a></li><li><a class="tocitem" href="../debug_mode.html">Debug mode</a></li></ul></li><li><span class="tocitem">How to support ChainRules rules as an AD package author</span><ul><li><a class="tocitem" href="../../ad_author/use_in_ad_system.html">Usage in AD</a></li><li><a class="tocitem" href="../../ad_author/call_back_into_ad.html">Suport calling back into ADs</a></li><li><a class="tocitem" href="../../ad_author/opt_out.html">Support opting out of rules</a></li></ul></li><li><span class="tocitem">The maths</span><ul><li><a class="tocitem" href="../../maths/propagators.html">The propagators: pushforward and pullback</a></li><li><a class="tocitem" href="../../maths/nondiff_points.html">Non-differentiable Points</a></li><li><a class="tocitem" href="../../maths/complex.html">Complex numbers</a></li><li><a class="tocitem" href="../../maths/arrays.html">Deriving array rules</a></li></ul></li><li><span class="tocitem">Design</span><ul><li><a class="tocitem" href="../../design/changing_the_primal.html">Changing the Primal</a></li><li><a class="tocitem" href="../../design/many_tangents.html">Many Tangent Types</a></li></ul></li><li><a class="tocitem" href="../../videos.html">Videos</a></li><li><a class="tocitem" href="../../FAQ.html">FAQ</a></li><li><a class="tocitem" href="../../api.html">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How to use ChainRules as a rule author</a></li><li><a class="is-disabled">Superpowers</a></li><li class="is-active"><a href="ruleconfig.html"><code>RuleConfig</code></a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="ruleconfig.html"><code>RuleConfig</code></a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaDiff/ChainRulesCore.jl/blob/main/docs/src/rule_author/superpowers/ruleconfig.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="config"><a class="docs-heading-anchor" href="#config">Rule configurations and calling back into AD</a><a id="config-1"></a><a class="docs-heading-anchor-permalink" href="#config" title="Permalink"></a></h1><p><a href="../../api.html#ChainRulesCore.RuleConfig"><code>RuleConfig</code></a> is a method for making rules conditionally defined based on the presence of certain features in the AD system. One key such feature is the ability to perform AD either in forwards or reverse mode or both.</p><p>This is done with a trait-like system (not Holy Traits), where the <code>RuleConfig</code> has a union of types as its only type-parameter. Where each type represents a particular special feature of this AD. To indicate that the AD system has a special property, its <code>RuleConfig</code> should be defined as:</p><pre><code class="language-julia hljs">struct MyADRuleConfig &lt;: RuleConfig{Union{Feature1, Feature2}} end</code></pre><p>And rules that should only be defined when an AD has a particular special property write:</p><pre><code class="language-julia hljs">rrule(::RuleConfig{&gt;:Feature1}, f, args...) = # rrule that should only be define for ADs with `Feature1`

frule(::RuleConfig{&gt;:Union{Feature1,Feature2}}, f, args...) = # frule that should only be define for ADs with both `Feature1` and `Feature2`</code></pre><div class="admonition is-warning"><header class="admonition-header">Rules with Config always take precedence over rules without</header><div class="admonition-body"><p>Even if the other arguments are more specific the rule with the config will always take precedence. For example of there is a rule <code>rrule(::RuleConfig, ::typeof(foo), ::Any)</code> and other <code>rrule(foo, ::Float64)</code>, the first will always be selected. This is because the AD will always attempt to provide its config when checking for a rule, and only if that doesn&#39;t match, will the config-less rule be tried. In practice this doesn&#39;t happen often, but when it does the solution is a little ugly – though very similar to resolving method ambiguities.   You need to manually add methods that dispatch from a rule with config to the one without. See for example the <a href="https://github.com/JuliaDiff/ChainRules.jl/blob/4ad975826ea0639ad709aeb36cc5051b6bf82eaa/src/rulesets/Base/mapreduce.jl#L87-L113">rule for <code>sum(abs2, xs)</code> in ChainRules.jl</a>.</p></div></div><p>A prominent use of this is in declaring that the AD system can, or cannot support being called from within the rule definitions.</p><h2 id="Writing-rules-that-call-back-into-AD"><a class="docs-heading-anchor" href="#Writing-rules-that-call-back-into-AD">Writing rules that call back into AD</a><a id="Writing-rules-that-call-back-into-AD-1"></a><a class="docs-heading-anchor-permalink" href="#Writing-rules-that-call-back-into-AD" title="Permalink"></a></h2><p>To define e.g. rules for higher order functions, it is useful to be able to call back into the AD system to get it to do some work for you.</p><p>For example the rule for reverse mode AD for <code>map</code> might like to use forward mode AD if one is available. Particularly for the case where only a single input collection is being mapped over. In that case we know the most efficient way to compute that sub-program is in forwards, as each call with-in the map only takes a single input.</p><p>Note: the following is not the most efficient rule for <code>map</code> via forward, but attempts to be clearer for demonstration purposes.</p><pre><code class="language-julia hljs">function rrule(config::RuleConfig{&gt;:HasForwardsMode}, ::typeof(map), f::Function, x::Array{&lt;:Real})
    # real code would support functors/closures, but in interest of keeping example short we exclude it:
    @assert (fieldcount(typeof(f)) == 0) &quot;Functors/Closures are not supported&quot;

    y_and_ẏ = map(x) do xi
        frule_via_ad(config, (NoTangent(), one(xi)), f, xi)
    end
    y = first.(y_and_ẏ)
    ẏ = last.(y_and_ẏ)

    pullback_map(ȳ) = NoTangent(), NoTangent(), ȳ .* ẏ
    return y, pullback_map
end</code></pre><h2 id="Writing-rules-that-depend-on-other-special-requirements-of-the-AD."><a class="docs-heading-anchor" href="#Writing-rules-that-depend-on-other-special-requirements-of-the-AD.">Writing rules that depend on other special requirements of the AD.</a><a id="Writing-rules-that-depend-on-other-special-requirements-of-the-AD.-1"></a><a class="docs-heading-anchor-permalink" href="#Writing-rules-that-depend-on-other-special-requirements-of-the-AD." title="Permalink"></a></h2><p>The <code>&gt;:HasReverseMode</code> and <code>&gt;:HasForwardsMode</code> are two examples of special properties that a <code>RuleConfig</code> could allow. Others could also exist, but right now they are the only two. It is likely that in the future such will be provided for e.g. mutation support.</p><p>Such a thing would look like:</p><pre><code class="language-julia hljs">struct SupportsMutation end

function rrule(
    ::RuleConfig{&gt;:SupportsMutation}, typeof(push!), x::Vector
)
    y = push!(x)

    function push!_pullback(ȳ)
        pop!(x)  # undo change to primal incase it is used in another pullback we haven&#39;t called yet
        pop!(ȳ)  # accumulate gradient via mutating ȳ, then return ZeroTangent
        return NoTangent(), ZeroTangent()
    end

    return y, push!_pullback
end</code></pre><p>and it would be used in the AD e.g. as follows:</p><pre><code class="language-julia hljs">struct EnzymeRuleConfig &lt;: RuleConfig{Union{SupportsMutation, HasReverseMode, NoForwardsMode}}</code></pre><p>Note: you can only depend on the presence of a feature, not its absence. This means we may need to define features and their complements, when one is not the obvious default (as in the case of <a href="../../api.html#ChainRulesCore.HasReverseMode"><code>HasReverseMode</code></a>/<a href="../../api.html#ChainRulesCore.NoReverseMode"><code>NoReverseMode</code></a> and <a href="../../api.html#ChainRulesCore.HasForwardsMode"><code>HasForwardsMode</code></a>/<a href="../../api.html#ChainRulesCore.NoForwardsMode"><code>NoForwardsMode</code></a>.).</p><p>Such special properties generally should only be defined in <code>ChainRulesCore</code>. (Theoretically, they could be defined elsewhere, but the AD and the package containing the rule need to load them, and ChainRulesCore is the place for things like that.)</p><h2 id="Writing-rules-that-are-only-for-your-own-AD"><a class="docs-heading-anchor" href="#Writing-rules-that-are-only-for-your-own-AD">Writing rules that are only for your own AD</a><a id="Writing-rules-that-are-only-for-your-own-AD-1"></a><a class="docs-heading-anchor-permalink" href="#Writing-rules-that-are-only-for-your-own-AD" title="Permalink"></a></h2><p>A special case of the above is writing rules that are defined only for your own AD. Rules which otherwise would be type-piracy, and would affect other AD systems. This could be done via making up a special property type and dispatching on it. But there is no need, as we can dispatch on the <code>RuleConfig</code> subtype directly.</p><p>For example in order to avoid mutation in nested AD situations, Zygote might want to have a rule for <a href="../../api.html#ChainRulesCore.add!!"><code>add!!</code></a> that makes it just do <code>+</code>.</p><pre><code class="language-julia hljs">struct ZygoteConfig &lt;: RuleConfig{Union{}} end

rrule(::ZygoteConfig, typeof(ChainRulesCore.add!!), a, b) = a+b, Δ-&gt;(NoTangent(), Δ, Δ)</code></pre><p>As an alternative to rules only for one AD, would be to add new special property definitions to ChainRulesCore (as described above) which would capture what makes that AD special.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="opt_out.html">« <code>@opt_out</code></a><a class="docs-footer-nextpage" href="gradient_accumulation.html">Gradient accumulation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.22 on <span class="colophon-date" title="Tuesday 13 September 2022 04:15">Tuesday 13 September 2022</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>

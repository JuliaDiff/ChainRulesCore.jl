<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Which functions need rules? · ChainRules</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../index.html"><img src="../assets/logo.svg" alt="ChainRules logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../index.html">ChainRules</a></span></div><form class="docs-search" action="../search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../index.html">Introduction</a></li><li><span class="tocitem">How to use ChainRules as a rule author</span><ul><li><a class="tocitem" href="intro.html">Introduction</a></li><li><a class="tocitem" href="example.html">Pedagogical example</a></li><li><a class="tocitem" href="tangents.html">Tangent types</a></li><li class="is-active"><a class="tocitem" href="which_functions_need_rules.html">Which functions need rules?</a></li><li><a class="tocitem" href="rule_definition_tools.html">Rule definition tools</a></li><li><a class="tocitem" href="writing_good_rules.html">Writing good rules</a></li><li><a class="tocitem" href="testing.html">Testing your rules</a></li><li><input class="collapse-toggle" id="menuitem-2-8" type="checkbox"/><label class="tocitem" for="menuitem-2-8"><span class="docs-label">Superpowers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="superpowers/projectto.html"><code>ProjectTo</code></a></li><li><a class="tocitem" href="superpowers/opt_out.html"><code>@opt_out</code></a></li><li><a class="tocitem" href="superpowers/ruleconfig.html"><code>RuleConfig</code></a></li><li><a class="tocitem" href="superpowers/gradient_accumulation.html">Gradient accumulation</a></li></ul></li><li><a class="tocitem" href="converting_zygoterules.html">Converting ZygoteRules.@adjoint to rrules</a></li><li><a class="tocitem" href="tips_for_packages.html">Tips for making your package work with AD</a></li><li><a class="tocitem" href="debug_mode.html">Debug mode</a></li></ul></li><li><span class="tocitem">How to support ChainRules rules as an AD package author</span><ul><li><a class="tocitem" href="../ad_author/use_in_ad_system.html">Usage in AD</a></li><li><a class="tocitem" href="../ad_author/call_back_into_ad.html">Suport calling back into ADs</a></li><li><a class="tocitem" href="../ad_author/opt_out.html">Support opting out of rules</a></li></ul></li><li><span class="tocitem">The maths</span><ul><li><a class="tocitem" href="../maths/propagators.html">The propagators: pushforward and pullback</a></li><li><a class="tocitem" href="../maths/nondiff_points.html">Non-differentiable Points</a></li><li><a class="tocitem" href="../maths/complex.html">Complex numbers</a></li><li><a class="tocitem" href="../maths/arrays.html">Deriving array rules</a></li></ul></li><li><span class="tocitem">Design</span><ul><li><a class="tocitem" href="../design/changing_the_primal.html">Changing the Primal</a></li><li><a class="tocitem" href="../design/many_tangents.html">Many Tangent Types</a></li></ul></li><li><a class="tocitem" href="../videos.html">Videos</a></li><li><a class="tocitem" href="../FAQ.html">FAQ</a></li><li><a class="tocitem" href="../api.html">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How to use ChainRules as a rule author</a></li><li class="is-active"><a href="which_functions_need_rules.html">Which functions need rules?</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="which_functions_need_rules.html">Which functions need rules?</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaDiff/ChainRulesCore.jl/blob/main/docs/src/rule_author/which_functions_need_rules.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Which-functions-need-rules?"><a class="docs-heading-anchor" href="#Which-functions-need-rules?">Which functions need rules?</a><a id="Which-functions-need-rules?-1"></a><a class="docs-heading-anchor-permalink" href="#Which-functions-need-rules?" title="Permalink"></a></h1><p>In principle, a perfect AD system only needs rules for basic operations and can infer the rules for more complicated functions automatically. In practice, performance needs to be considered as well.</p><p>Some functions use <code>ccall</code> internally, for example <a href="https://github.com/JuliaLang/julia/blob/v1.5.3/base/math.jl#L886"><code>^</code></a>. These functions cannot be differentiated through by AD systems, and need custom rules.</p><p>Other functions can in principle be differentiated through by an AD system, but there exists a mathematical insight that can dramatically improve the computation of the derivative. An example is numerical integration, where writing a rule implementing the <a href="https://en.wikipedia.org/wiki/Fundamental_theorem_of_calculus">fundamental theorem of calculus</a> removes the need to perform AD through numerical integration.</p><p>Furthermore, AD systems make different trade-offs in performance due to their design. This means that a certain rule will help one AD system, but not improve (and also not harm) another. Below, we list some patterns relevant for the <a href="https://github.com/FluxML/Zygote.jl">Zygote.jl</a> AD system.</p><p>Rules for functions which mutate its arguments, e.g. <code>sort!</code>, should not be written at the moment. While technically they are supported, they would break <a href="https://github.com/FluxML/Zygote.jl">Zygote.jl</a> such that <a href="https://github.com/JuliaDiff/ChainRulesCore.jl/issues/242">it would sometimes quietly return the wrong answer</a>. This may be resolved in the future by <a href="https://github.com/JuliaDiff/ChainRulesCore.jl/issues/270">allowing AD systems to opt-in or opt-out of certain types of rules</a>.</p><h3 id="Patterns-that-need-rules-in-[Zygote.jl](https://github.com/FluxML/Zygote.jl)"><a class="docs-heading-anchor" href="#Patterns-that-need-rules-in-[Zygote.jl](https://github.com/FluxML/Zygote.jl)">Patterns that need rules in <a href="https://github.com/FluxML/Zygote.jl">Zygote.jl</a></a><a id="Patterns-that-need-rules-in-[Zygote.jl](https://github.com/FluxML/Zygote.jl)-1"></a><a class="docs-heading-anchor-permalink" href="#Patterns-that-need-rules-in-[Zygote.jl](https://github.com/FluxML/Zygote.jl)" title="Permalink"></a></h3><p>There are a few classes of functions that Zygote cannot differentiate through. Custom rules will need to be written for these to make AD work.</p><p>Other patterns can be AD&#39;ed through, but the backward pass performance can be greatly improved by writing a rule.</p><h4 id="Functions-which-mutate-arrays"><a class="docs-heading-anchor" href="#Functions-which-mutate-arrays">Functions which mutate arrays</a><a id="Functions-which-mutate-arrays-1"></a><a class="docs-heading-anchor-permalink" href="#Functions-which-mutate-arrays" title="Permalink"></a></h4><p>For example,</p><pre><code class="language-julia hljs">function addone(a::AbstractArray)
    b = similar(a)
    b .= a .+ 1
    return sum(b)
end</code></pre><p>complains that</p><pre><code class="language-julia hljs">julia&gt; using Zygote
julia&gt; gradient(addone, a)
ERROR: Mutating arrays is not supported</code></pre><p>However, upon adding the <code>rrule</code> (restart the REPL after calling <code>gradient</code>)</p><pre><code class="language-julia hljs">function ChainRules.rrule(::typeof(addone), a)
    y = addone(a)
    function addone_pullback(ȳ)
        return NoTangent(), ones(length(a))
    end
    return y, addone_pullback
end</code></pre><p>the gradient can be evaluated:</p><pre><code class="language-julia hljs">julia&gt; gradient(addone, a)
([1.0, 1.0, 1.0],)</code></pre><p>Notice that <code>addone(a)</code> mutates another array <code>b</code> internally, but <strong>not</strong> its input. This is commonly done in less trivial functions, and is often what Zygote&#39;s <code>Mutating arrays is not supported</code> error is telling you, even though you did not intend to mutate anything. Functions which mutate their own input are much more problematic. These are the ones named (by convention) with an exclamation mark, such as <code>fill!(a, x)</code> or <code>push!(a, x)</code>. It is not possible to write rules which handle all uses of such a function correctly, on current Zygote.</p><div class="admonition is-info"><header class="admonition-header">Why restarting REPL after calling `gradient`?</header><div class="admonition-body"><p>When <code>gradient</code> is called in <code>Zygote</code> for a function with no <code>rrule</code> defined, a backward pass for the function call is generated and cached. When <code>gradient</code> is called for the second time on the same function signature, the backward pass is reused without checking whether an an <code>rrule</code> has been defined between the two calls to <code>gradient</code>.</p><p>If an <code>rrule</code> is defined before the first call to <code>gradient</code> it should register the rule and use it, but that prevents comparing what happens before and after the <code>rrule</code> is defined. To compare both versions with and without an <code>rrule</code> in the REPL simultaneously, define a function <code>f(x) = &lt;body&gt;</code> (no <code>rrule</code>), another function <code>f_cr(x) = f(x)</code>, and an <code>rrule</code> for <code>f_cr</code>.</p><p>Calling <code>Zygote.refresh()</code> will often have the same effect as restarting the REPL.</p></div></div><h4 id="Exception-handling"><a class="docs-heading-anchor" href="#Exception-handling">Exception handling</a><a id="Exception-handling-1"></a><a class="docs-heading-anchor-permalink" href="#Exception-handling" title="Permalink"></a></h4><p>Zygote does not support differentiating through <code>try</code>/<code>catch</code> statements. For example, differentiating through</p><pre><code class="language-julia hljs">function exception(x)
    try
        return x^2
    catch e
        println(&quot;could not square input&quot;)
        throw(e)
    end
end</code></pre><p>does not work</p><pre><code class="language-julia hljs">julia&gt; gradient(exception, 3.0)
ERROR: Compiling Tuple{typeof(exception),Int64}: try/catch is not supported.</code></pre><p>without an <code>rrule</code> defined (restart the REPL after calling <code>gradient</code>)</p><pre><code class="language-julia hljs">function ChainRulesCore.rrule(::typeof(exception), x)
    y = exception(x)
    function exception_pullback(ȳ)
        return NoTangent(), 2*x
    end
    return y, exception_pullback
end</code></pre><pre><code class="language-julia hljs">julia&gt; gradient(exception, 3.0)
(6.0,)</code></pre><h4 id="Loops"><a class="docs-heading-anchor" href="#Loops">Loops</a><a id="Loops-1"></a><a class="docs-heading-anchor-permalink" href="#Loops" title="Permalink"></a></h4><p>Julia runs loops fast. Unfortunately Zygote differentiates through loops slowly. So, for example, computing the mean squared error by using a loop</p><pre><code class="language-julia hljs">function mse(y, ŷ)
    N = length(y)
    s = 0.0
    for i in 1:N
        s +=  (y[i] - ŷ[i])^2.0
    end
    return s/N
end</code></pre><p>takes a lot longer to AD through</p><pre><code class="language-julia hljs">julia&gt; y = rand(30)
julia&gt; ŷ = rand(30)
julia&gt; @btime gradient(mse, $y, $ŷ)
  38.180 μs (993 allocations: 65.00 KiB)</code></pre><p>than if we supply an <code>rrule</code>, (restart the REPL after calling <code>gradient</code>)</p><pre><code class="language-julia hljs">function ChainRules.rrule(::typeof(mse), x, x̂)
    output = mse(x, x̂)
    function mse_pullback(ȳ)
        N = length(x)
        g = (2 ./ N) .* (x .- x̂) .* ȳ
        return NoTangent(), g, -g
    end
    return output, mse_pullback
end</code></pre><p>which is much faster</p><pre><code class="language-julia hljs">julia&gt; @btime gradient(mse, $y, $ŷ)
  143.697 ns (2 allocations: 672 bytes)</code></pre><h4 id="Inplace-accumulation"><a class="docs-heading-anchor" href="#Inplace-accumulation">Inplace accumulation</a><a id="Inplace-accumulation-1"></a><a class="docs-heading-anchor-permalink" href="#Inplace-accumulation" title="Permalink"></a></h4><p>Inplace accumulation of gradients is slow in <code>Zygote</code>. The issue, demonstrated in the folowing example, is that the gradient of <code>getindex</code> allocates an array of zeros with a single non-zero element. </p><pre><code class="language-julia hljs">function sum3(array)
    x = array[1]
    y = array[2]
    z = array[3]
    return x+y+z
end</code></pre><pre><code class="language-julia hljs">julia&gt; @btime gradient(sum3, rand(30))
  424.510 ns (9 allocations: 2.06 KiB)</code></pre><p>Computing the gradient with only a single array allocation using an <code>rrule</code> (restart the REPL after calling <code>gradient</code>)</p><pre><code class="language-julia hljs">function ChainRulesCore.rrule(::typeof(sum3), a)
    y = sum3(a)
    function sum3_pullback(ȳ)
        grad = zeros(length(a))
        grad[1:3] .+= ȳ
        return NoTangent(), grad
    end
    return y, sum3_pullback
end</code></pre><p>turns out to be significantly faster </p><pre><code class="language-julia hljs">julia&gt; @btime gradient(sum3, rand(30))
  192.818 ns (3 allocations: 784 bytes)</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="tangents.html">« Tangent types</a><a class="docs-footer-nextpage" href="rule_definition_tools.html">Rule definition tools »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.22 on <span class="colophon-date" title="Thursday 22 December 2022 02:36">Thursday 22 December 2022</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>

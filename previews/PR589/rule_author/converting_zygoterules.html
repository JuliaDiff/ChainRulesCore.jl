<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Converting ZygoteRules.@adjoint to rrules · ChainRules</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../index.html"><img src="../assets/logo.svg" alt="ChainRules logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../index.html">ChainRules</a></span></div><form class="docs-search" action="../search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../index.html">Introduction</a></li><li><span class="tocitem">How to use ChainRules as a rule author</span><ul><li><a class="tocitem" href="intro.html">Introduction</a></li><li><a class="tocitem" href="example.html">Pedagogical example</a></li><li><a class="tocitem" href="tangents.html">Tangent types</a></li><li><a class="tocitem" href="which_functions_need_rules.html">Which functions need rules?</a></li><li><a class="tocitem" href="rule_definition_tools.html">Rule definition tools</a></li><li><a class="tocitem" href="writing_good_rules.html">Writing good rules</a></li><li><a class="tocitem" href="testing.html">Testing your rules</a></li><li><input class="collapse-toggle" id="menuitem-2-8" type="checkbox"/><label class="tocitem" for="menuitem-2-8"><span class="docs-label">Superpowers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="superpowers/projectto.html"><code>ProjectTo</code></a></li><li><a class="tocitem" href="superpowers/opt_out.html"><code>@opt_out</code></a></li><li><a class="tocitem" href="superpowers/ruleconfig.html"><code>RuleConfig</code></a></li><li><a class="tocitem" href="superpowers/gradient_accumulation.html">Gradient accumulation</a></li></ul></li><li class="is-active"><a class="tocitem" href="converting_zygoterules.html">Converting ZygoteRules.@adjoint to rrules</a><ul class="internal"><li><a class="tocitem" href="#Example"><span>Example</span></a></li><li><a class="tocitem" href="#Write-as-a-rrule(::typeof(f),-...)"><span>Write as a <code>rrule(::typeof(f), ...)</code></span></a></li><li><a class="tocitem" href="#Include-the-derivative-with-respect-to-the-function-object-itself"><span>Include the derivative with respect to the function object itself</span></a></li><li><a class="tocitem" href="#Tangent-Type-changes"><span>Tangent Type changes</span></a></li><li><a class="tocitem" href="#Calling-back-into-AD-(ZygoteRules.pullback)"><span>Calling back into AD (<code>ZygoteRules.pullback</code>)</span></a></li><li><a class="tocitem" href="#Consider-adding-some-thunks"><span>Consider adding some thunks</span></a></li><li><a class="tocitem" href="#Testing-Changes"><span>Testing Changes</span></a></li><li><a class="tocitem" href="#@nograd-becomes-@non_differentiable"><span><code>@nograd</code> becomes <code>@non_differentiable</code></span></a></li><li><a class="tocitem" href="#No-such-thing-as-literal_getproperty"><span>No such thing as <code>literal_getproperty</code></span></a></li><li><a class="tocitem" href="#Take-embedded-spaces-and-types-seriously"><span>Take embedded spaces and types seriously</span></a></li><li><a class="tocitem" href="#What-if-I-miss-something"><span>What if I miss something</span></a></li></ul></li><li><a class="tocitem" href="tips_for_packages.html">Tips for making your package work with AD</a></li><li><a class="tocitem" href="debug_mode.html">Debug mode</a></li></ul></li><li><span class="tocitem">How to support ChainRules rules as an AD package author</span><ul><li><a class="tocitem" href="../ad_author/use_in_ad_system.html">Usage in AD</a></li><li><a class="tocitem" href="../ad_author/call_back_into_ad.html">Suport calling back into ADs</a></li><li><a class="tocitem" href="../ad_author/opt_out.html">Support opting out of rules</a></li></ul></li><li><span class="tocitem">The maths</span><ul><li><a class="tocitem" href="../maths/propagators.html">The propagators: pushforward and pullback</a></li><li><a class="tocitem" href="../maths/nondiff_points.html">Non-differentiable Points</a></li><li><a class="tocitem" href="../maths/complex.html">Complex numbers</a></li><li><a class="tocitem" href="../maths/arrays.html">Deriving array rules</a></li></ul></li><li><span class="tocitem">Design</span><ul><li><a class="tocitem" href="../design/changing_the_primal.html">Changing the Primal</a></li><li><a class="tocitem" href="../design/many_tangents.html">Many Tangent Types</a></li></ul></li><li><a class="tocitem" href="../videos.html">Videos</a></li><li><a class="tocitem" href="../FAQ.html">FAQ</a></li><li><a class="tocitem" href="../api.html">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How to use ChainRules as a rule author</a></li><li class="is-active"><a href="converting_zygoterules.html">Converting ZygoteRules.@adjoint to rrules</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="converting_zygoterules.html">Converting ZygoteRules.@adjoint to rrules</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaDiff/ChainRulesCore.jl/blob/main/docs/src/rule_author/converting_zygoterules.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Converting-ZygoteRules.@adjoint-to-rrules"><a class="docs-heading-anchor" href="#Converting-ZygoteRules.@adjoint-to-rrules">Converting ZygoteRules.@adjoint to <code>rrule</code>s</a><a id="Converting-ZygoteRules.@adjoint-to-rrules-1"></a><a class="docs-heading-anchor-permalink" href="#Converting-ZygoteRules.@adjoint-to-rrules" title="Permalink"></a></h1><p><a href="https://github.com/FluxML/ZygoteRules.jl">ZygoteRules.jl</a> is a legacy package similar to ChainRulesCore but supporting <a href="https://github.com/FluxML/Zygote.jl">Zygote.jl</a> only.</p><p>If you have some rules written with ZygoteRules it is a good idea to upgrade them to use ChainRules instead. Zygote will still be able to use them, but so will other AD systems, and you will get access to some more advanced features. Some of these features are currently ignored by Zygote, but could be supported in the future.</p><h2 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h2><p>Consider the function</p><pre><code class="language-julia hljs">struct Foo
    a::Float64,
    b::Float64
end

f(x, y::Foo, z) = 2*x + y.a</code></pre><h3 id="ZygoteRules"><a class="docs-heading-anchor" href="#ZygoteRules">ZygoteRules</a><a id="ZygoteRules-1"></a><a class="docs-heading-anchor-permalink" href="#ZygoteRules" title="Permalink"></a></h3><pre><code class="language-julia hljs">@adjoint function f(x, y::Foo, z)
    f_pullback(Ω̄) = (2Ω̄, NamedTuple(;a=Ω̄, b=nothing), nothing)
    return f(x, y, z), f_pullback
end</code></pre><h3 id="ChainRules"><a class="docs-heading-anchor" href="#ChainRules">ChainRules</a><a id="ChainRules-1"></a><a class="docs-heading-anchor-permalink" href="#ChainRules" title="Permalink"></a></h3><pre><code class="language-julia hljs">function rrule(::typeof(f), x, y::Foo, z)
    f_pullback(Ω̄) = (NoTangent(), 2Ω̄, Tangent{Foo}(;a=Ω̄), ZeroTangent())
    return f(x, y, z), f_pullback
end</code></pre><h2 id="Write-as-a-rrule(::typeof(f),-...)"><a class="docs-heading-anchor" href="#Write-as-a-rrule(::typeof(f),-...)">Write as a <code>rrule(::typeof(f), ...)</code></a><a id="Write-as-a-rrule(::typeof(f),-...)-1"></a><a class="docs-heading-anchor-permalink" href="#Write-as-a-rrule(::typeof(f),-...)" title="Permalink"></a></h2><p>No magic macro here, <code>rrule</code> is the function that it is. The function it is the rule for is the first argument, or second argument if you need to take a <a href="../api.html#ChainRulesCore.RuleConfig"><code>RuleConfig</code></a>.</p><p>Note that when writing the rule for constructor you will need to use <code>::Type{Foo}</code>, not <code>typeof(Foo)</code>. See docs on <a href="writing_good_rules.html#Constructors">Constructors</a>.</p><h2 id="Include-the-derivative-with-respect-to-the-function-object-itself"><a class="docs-heading-anchor" href="#Include-the-derivative-with-respect-to-the-function-object-itself">Include the derivative with respect to the function object itself</a><a id="Include-the-derivative-with-respect-to-the-function-object-itself-1"></a><a class="docs-heading-anchor-permalink" href="#Include-the-derivative-with-respect-to-the-function-object-itself" title="Permalink"></a></h2><p>The <code>ZygoteRules.@adjoint</code> macro automagically<sup class="footnote-reference"><a id="citeref-1" href="#footnote-1">[1]</a></sup> inserts an extra <code>nothing</code> in the return for the function it generates to represent the derivative of output with respect to the function object. ChainRules as a philosophy avoids magic as much as possible, and thus require you to return it explicitly. If it is a plain function (like <code>typeof(sin)</code>), then the tangent will be <a href="../api.html#ChainRulesCore.NoTangent"><code>NoTangent</code></a>.</p><h2 id="Tangent-Type-changes"><a class="docs-heading-anchor" href="#Tangent-Type-changes">Tangent Type changes</a><a id="Tangent-Type-changes-1"></a><a class="docs-heading-anchor-permalink" href="#Tangent-Type-changes" title="Permalink"></a></h2><p>ChainRules uses tangent types that must represent vector spaces (i.e. tangent spaces). They need to have things like <code>+</code> defined on them. ZygoteRules takes a more adhoc approach to this.</p><h3 id="nothing-becomes-an-AbstractZero"><a class="docs-heading-anchor" href="#nothing-becomes-an-AbstractZero"><code>nothing</code> becomes an <code>AbstractZero</code></a><a id="nothing-becomes-an-AbstractZero-1"></a><a class="docs-heading-anchor-permalink" href="#nothing-becomes-an-AbstractZero" title="Permalink"></a></h3><p>ZygoteRules uses nothing to represent some sense of zero, in a primal type agnostic way. There are many senses of zero. ChainRules represents two of them, as subtypes of <a href="../api.html#ChainRulesCore.AbstractZero"><code>AbstractZero</code></a>.</p><p><a href="../api.html#ChainRulesCore.ZeroTangent"><code>ZeroTangent</code></a> for the case that there is no relationship between the primal output and the primal input. <a href="../api.html#ChainRulesCore.NoTangent"><code>NoTangent</code></a> for the case where conceptually the tangent space doesn&#39;t exist. e.g. what is the Tangent to a String or an index: those can&#39;t be perturbed.</p><p>See <a href="../FAQ.html#faq_abstract_zero">FAQ on the difference between <code>ZeroTangent</code> and <code>NoTangent</code></a>. At the end of the day it doesn&#39;t matter too much if you get them wrong. <code>NoTangent</code> and <code>ZeroTangent</code> more or less act identically.</p><h3 id="Tuples-and-NamedTuples-become-Tangent{T}s"><a class="docs-heading-anchor" href="#Tuples-and-NamedTuples-become-Tangent{T}s"><code>Tuple</code>s and <code>NamedTuple</code>s become <code>Tangent{T}</code>s</a><a id="Tuples-and-NamedTuples-become-Tangent{T}s-1"></a><a class="docs-heading-anchor-permalink" href="#Tuples-and-NamedTuples-become-Tangent{T}s" title="Permalink"></a></h3><p>Zygote uses <code>Tuple</code>s and <code>NamedTuple</code>s to represent the structural tangents for <code>Tuple</code>s and <code>struct</code>s respectively. ChainRules core provides a generic <a href="../api.html#ChainRulesCore.Tangent"><code>Tangent{T}</code></a> to represent the structural tangent of a primal type <code>T</code>. It takes positional arguments if representing tangent for a <code>Tuple</code>. Or keyword argument to represent the tangent for a <code>struct</code> or a <code>NamedTuple</code>. When representing a <code>struct</code> you only need to list the nonzero fields – any not given are implicit considered to be <a href="../api.html#ChainRulesCore.ZeroTangent"><code>ZeroTangent</code></a>.</p><p>When we say structural tangent we mean tangent types that are based only on the structure of the primal. This is in contrast to a natural tangent which captures some knowledge based on what the primal type represents. (E.g. for arrays a natural tangent is often the same kind of array). For more details see the the <a href="../design/many_tangents.html#manytypes">design docs on the many tangent types</a></p><h2 id="Calling-back-into-AD-(ZygoteRules.pullback)"><a class="docs-heading-anchor" href="#Calling-back-into-AD-(ZygoteRules.pullback)">Calling back into AD (<code>ZygoteRules.pullback</code>)</a><a id="Calling-back-into-AD-(ZygoteRules.pullback)-1"></a><a class="docs-heading-anchor-permalink" href="#Calling-back-into-AD-(ZygoteRules.pullback)" title="Permalink"></a></h2><p>Rules that need to call back into the AD system, e.g, for higher order functions like <code>map(f, xs)</code>, need to be changed. In <code>ZygoteRules</code> you can use <code>ZygoteRules.pullback</code> or <code>ZygoteRules._pullback</code>, which will always result in calling into Zygote. Since ChainRules is AD agnostic, you can&#39;t do that. Instead you use a <a href="../api.html#ChainRulesCore.RuleConfig"><code>RuleConfig</code></a> to specify requirements of an AD system e.g <code>::RuleConfig{&gt;:HasReverseMode}</code> work for Zygote, and then use <a href="../api.html#ChainRulesCore.rrule_via_ad"><code>rrule_via_ad</code></a>.</p><p>See the <a href="superpowers/ruleconfig.html#config">docs on calling back into AD</a> for more details.</p><h2 id="Consider-adding-some-thunks"><a class="docs-heading-anchor" href="#Consider-adding-some-thunks">Consider adding some thunks</a><a id="Consider-adding-some-thunks-1"></a><a class="docs-heading-anchor-permalink" href="#Consider-adding-some-thunks" title="Permalink"></a></h2><p>A feature ChainRulesCore offers that ZygoteRules doesn&#39;t is support for thunks. Thunks delay work until it is needed, and avoid it if it never is. See docs on <a href="../api.html#ChainRulesCore.@thunk-Tuple{Any}"><code>@thunk</code></a>, <a href="../api.html#ChainRulesCore.Thunk"><code>Thunk</code></a>, <a href="../api.html#ChainRulesCore.InplaceableThunk"><code>InplaceableThunk</code></a>.</p><p>You don&#39;t have to use thunks, though. It is easy to go overboard with using thunks.</p><h2 id="Testing-Changes"><a class="docs-heading-anchor" href="#Testing-Changes">Testing Changes</a><a id="Testing-Changes-1"></a><a class="docs-heading-anchor-permalink" href="#Testing-Changes" title="Permalink"></a></h2><p>One of the advantages of using ChainRules is that you can easily and robustly test your rules with <a href="https://juliadiff.org/ChainRulesTestUtils.jl/stable/">ChainRulesTestUtils.jl</a>. This uses finite differencing to test the accuracy of derivative, as well as checks the correctness of the API. It should catch anything you might have gotten wrong referred to in this page.</p><p>The test for the above example is <code>test_rrule(f, 2.5, Foo(9.9, 7.2), 31.0)</code>. You can see it looks a lot like an example call to <code>rrule</code>, just with the prefix <code>test_</code> added to the start.</p><h2 id="@nograd-becomes-@non_differentiable"><a class="docs-heading-anchor" href="#@nograd-becomes-@non_differentiable"><code>@nograd</code> becomes <code>@non_differentiable</code></a><a id="@nograd-becomes-@non_differentiable-1"></a><a class="docs-heading-anchor-permalink" href="#@nograd-becomes-@non_differentiable" title="Permalink"></a></h2><p>Probably more or less with no changes. <a href="../api.html#ChainRulesCore.@non_differentiable-Tuple{Any}"><code>@non_differentiable</code></a> also lets you specify a signature in case you want to restrict non-differentiability to a certain subset of argument types.</p><h2 id="No-such-thing-as-literal_getproperty"><a class="docs-heading-anchor" href="#No-such-thing-as-literal_getproperty">No such thing as <code>literal_getproperty</code></a><a id="No-such-thing-as-literal_getproperty-1"></a><a class="docs-heading-anchor-permalink" href="#No-such-thing-as-literal_getproperty" title="Permalink"></a></h2><p>That is just <code>getproperty</code>, it takes <code>Symbol</code>. It should constant-fold. It likely doesn&#39;t though as Zygote doesn&#39;t play nice with the optimizer.</p><h2 id="Take-embedded-spaces-and-types-seriously"><a class="docs-heading-anchor" href="#Take-embedded-spaces-and-types-seriously">Take embedded spaces and types seriously</a><a id="Take-embedded-spaces-and-types-seriously-1"></a><a class="docs-heading-anchor-permalink" href="#Take-embedded-spaces-and-types-seriously" title="Permalink"></a></h2><p>Traditionally Zygote has taken a very laissez-faire attitude towards types and mathematical spaces. Sometimes treating <code>Real</code>s as embedded in the <code>Complex</code> plane; sometimes not. Sometimes treating sparse and structuredly-sparse matrix as embedded in the space of dense matrices. Writing rules that apply to any <code>Array{T}</code> which perhaps are only applicable for <code>Array{&lt;:Real}</code> and not so much for <code>Array{Quaternion}</code>. Traditionally ChainRules takes a much more considered approach.</p><p>See for example our <a href="../maths/complex.html#complexfunctions">docs on how to handle complex numbers</a> correctly. (The outcome of several long long long discussions with a number of experts in our community)</p><p>Now, I am not here to tell you what to do in your package, but this is a good time to reconsider how seriously you take these things in the rules you are converting.</p><h2 id="What-if-I-miss-something"><a class="docs-heading-anchor" href="#What-if-I-miss-something">What if I miss something</a><a id="What-if-I-miss-something-1"></a><a class="docs-heading-anchor-permalink" href="#What-if-I-miss-something" title="Permalink"></a></h2><p>It is not great, but it probably OK. Zygote&#39;s ChainRules interface is fairly forgiving. Other AD systems may not be. If you test with <a href="https://juliadiff.org/ChainRulesTestUtils.jl/stable/">ChainRulesTestUtils.jl</a> then you can be confident that you didn&#39;t miss anything.</p><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-1"><a class="tag is-link" href="#citeref-1">1</a>unless you write it in functor form (i.e. <code>@adjoint (f::MyType)(args...)=...</code>), in that case like for <code>rrule</code> you need to include it explictly.</li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="superpowers/gradient_accumulation.html">« Gradient accumulation</a><a class="docs-footer-nextpage" href="tips_for_packages.html">Tips for making your package work with AD »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.22 on <span class="colophon-date" title="Wednesday 21 September 2022 19:45">Wednesday 21 September 2022</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
